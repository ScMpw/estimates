<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Effort per Issue Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: sans-serif; background: #f7f8fa; margin: 0; }
    .container { max-width: 650px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; padding: 32px 24px; }
    h2 { margin-top: 0; }
    input[type=file] { margin: 8px 0 16px 0; }
    table { border-collapse: collapse; width: 100%; background: #fcfcfc; margin-top: 28px; }
    th, td { border: 1px solid #ececec; padding: 10px 8px; text-align: left; }
    th { background: #f4f6f8; }
    tr:hover { background: #f1f8fa; }
    .footer { color: #777; margin-top: 60px; font-size: 13px; }
    .notfound { color: #a00; margin: 24px 0 0 0; }
    .headers { color: #555; font-size: 13px; margin: 16px 0 0 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Effort per Issue</h2>
    <div>
      <label><b>Upload CSV:</b>
        <input type="file" id="csvfile" accept=".csv,text/csv" />
      </label>
    </div>
    <div id="tableDiv"></div>
    <div id="headerDebug"></div>
    <div class="footer">(No data is sent to any server. All processing happens in your browser.)</div>
  </div>
  <script>
    function detectDelimiter(text) {
      // Check first line for ; or ,
      const firstLine = text.split(/\r?\n/)[0];
      const comma = (firstLine.match(/,/g) || []).length;
      const semicolon = (firstLine.match(/;/g) || []).length;
      return semicolon > comma ? ";" : ",";
    }

    function parseCSV(text, delimiter) {
      // Split lines, ignore empty
      const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(l => l.trim() !== "");
      // Use delimiter
      const headers = lines[0].split(delimiter).map(h => h.trim());
      return lines.slice(1).map(line => {
        const values = line.split(delimiter);
        const obj = {};
        headers.forEach((h, i) => obj[h] = (values[i] || "").trim());
        return obj;
      });
    }

    function normalizeHeaders(row) {
      // lowercase, remove spaces, remove special chars (ä=ae, ü=ue, ö=oe, ß=ss)
      const map = {};
      for (const k in row) {
        let norm = k.toLowerCase().replace(/\s+/g, "");
        norm = norm.replace(/[ä]/g, "ae").replace(/[ü]/g, "ue").replace(/[ö]/g, "oe").replace(/[ß]/g, "ss");
        map[norm] = k;
      }
      return map;
    }

    function extractIssueKey(aufgabe) {
      // Holt z.B. "BF-392" aus "BF-392: irgendwas"
      if (!aufgabe) return null;
      const match = aufgabe.match(/^([A-Z]+-\d+)/i);
      return match ? match[1] : null;
    }

    document.getElementById("csvfile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        let text = evt.target.result;
        text = text.replace(/,(\d)/g, '.$1'); // Convert decimal commas

        const delimiter = detectDelimiter(text);
        const csvRows = parseCSV(text, delimiter);

        if (!csvRows.length) {
          document.getElementById("tableDiv").innerHTML = '<div class="notfound">No data rows found.</div>';
          return;
        }

        // Header-Normalisierung (finde die Spalten)
        const headerMap = normalizeHeaders(csvRows[0]);
        const aufgabeKey = Object.keys(headerMap).find(k => k.startsWith("aufgabe"));
        const stdKey = Object.keys(headerMap).find(k => k.startsWith("std"));
        const spKey = Object.keys(headerMap).find(k => k.startsWith("storypoints"));

        // Debug: Zeige alle Header
        document.getElementById("headerDebug").innerHTML = '<div class="headers">Detected columns: ' +
          Object.keys(headerMap).map(h => `<code>${headerMap[h]}</code>`).join(', ') + '</div>';

        if (!aufgabeKey || !stdKey || !spKey) {
          document.getElementById("tableDiv").innerHTML =
            `<div class="notfound">Could not find all required columns ("Aufgabe", "Std.", "StoryPoints")!<br>
            <br>Found columns: <code>${Object.keys(headerMap).map(h => headerMap[h]).join(", ")}</code></div>`;
          return;
        }

        // Group by extracted Issue Key from "Aufgabe"
        const issuesMap = {};
        csvRows.forEach(row => {
          const key = extractIssueKey(row[headerMap[aufgabeKey]]);
          if (!key) return;
          if (!issuesMap[key]) issuesMap[key] = { totalEffort: 0, storyPoints: null, count: 0 };
          let val = (row[headerMap[stdKey]] || "0").replace(",", ".");
          let eff = parseFloat(val || "0");
          if (!isNaN(eff)) issuesMap[key].totalEffort += eff;
          // Use first non-empty StoryPoints per issue
          if (issuesMap[key].storyPoints === null && row[headerMap[spKey]] !== undefined) {
            let sp = parseFloat(row[headerMap[spKey]]);
            if (!isNaN(sp)) issuesMap[key].storyPoints = sp;
          }
          issuesMap[key].count += 1;
        });

        // Convert to sorted array
        let issuesArr = Object.entries(issuesMap).map(([key, v]) => ({
          issue: key,
          totalEffort: v.totalEffort,
          storyPoints: v.storyPoints,
          effortPerSP: (v.storyPoints && v.storyPoints > 0) ? (v.totalEffort / v.storyPoints).toFixed(2) : "–",
          count: v.count
        }));
        issuesArr.sort((a, b) => a.issue.localeCompare(b.issue, undefined, { numeric: true }));

        // Show table
        const tableDiv = document.getElementById("tableDiv");
        if (issuesArr.length === 0) {
          tableDiv.innerHTML = '<div class="notfound">No issues found in file.</div>';
          return;
        }

        let html = `<table>
          <thead>
            <tr>
              <th>Issue Key</th>
              <th>Total Effort (h)</th>
              <th>Story Points</th>
              <th>Effort per Story Point</th>
            </tr>
          </thead>
          <tbody>
            ${issuesArr.map(issue => `
              <tr>
                <td>${issue.issue}</td>
                <td>${issue.totalEffort}</td>
                <td>${issue.storyPoints !== null ? issue.storyPoints : "–"}</td>
                <td>${issue.effortPerSP !== "NaN" ? issue.effortPerSP : "–"}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
        tableDiv.innerHTML = html;
      };
      reader.readAsText(file, "utf-8");
    });
  </script>
</body>
</html>
