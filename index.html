<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Effort per Issue Analysis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background: #f7f8fa; margin: 0; }
    .container { max-width: 950px; margin: 40px auto; background: #fff; border-radius: 14px; box-shadow: 0 2px 16px #0001; padding: 32px 24px; }
    h2 { margin-top: 0; }
    input[type=file] { margin: 8px 0 24px 0; }
    .chart-block { margin: 32px 0; }
    details { margin: 0 0 18px 0; background: #f7f8fc; border-radius: 8px; border: 1px solid #eee; }
    summary { font-weight: bold; padding: 10px 14px; cursor: pointer; outline: none;}
    .group-list { padding: 0 18px 12px 34px; }
    .group-list table, .average-table { width: 100%; border-collapse: collapse; background: #fafbfc; }
    .group-list th, .group-list td, .average-table th, .average-table td { border: 1px solid #ececec; padding: 7px 6px; text-align: left; }
    .group-list th, .average-table th { background: #f0f4f9; }
    .footer { color: #777; margin-top: 60px; font-size: 13px; }
    .notfound { color: #a00; margin: 24px 0 0 0; }
    .headers { color: #555; font-size: 13px; margin: 16px 0 0 0; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Effort per Issue Analysis</h2>
    <div>
      <label><b>Upload CSV:</b>
        <input type="file" id="csvfile" accept=".csv,text/csv" />
      </label>
    </div>
    <div id="headerDebug"></div>
    <div class="chart-block">
      <canvas id="pieChart" height="140"></canvas>
    </div>
    <div class="chart-block">
      <canvas id="scatterChart" height="220"></canvas>
    </div>
    <div class="chart-block">
      <canvas id="histogramChart" height="220"></canvas>
    </div>
    <div class="chart-block" id="avgEffortDiv"></div>
    <div id="groups"></div>
    <div class="footer">(No data is sent to any server. All processing happens in your browser.)</div>
  </div>
  <script>
    function detectDelimiter(text) {
      const firstLine = text.split(/\r?\n/)[0];
      const comma = (firstLine.match(/,/g) || []).length;
      const semicolon = (firstLine.match(/;/g) || []).length;
      return semicolon > comma ? ";" : ",";
    }

    function parseCSV(text, delimiter) {
      const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n').filter(l => l.trim() !== "");
      const headers = lines[0].split(delimiter).map(h => h.trim());
      return lines.slice(1).map(line => {
        const values = line.split(delimiter);
        const obj = {};
        headers.forEach((h, i) => obj[h] = (values[i] || "").trim());
        return obj;
      });
    }

    function normalizeHeaders(row) {
      const map = {};
      for (const k in row) {
        let norm = k.toLowerCase().replace(/\s+/g, "");
        norm = norm.replace(/[ä]/g, "ae").replace(/[ü]/g, "ue").replace(/[ö]/g, "oe").replace(/[ß]/g, "ss");
        map[norm] = k;
      }
      return map;
    }

    function extractIssueKey(aufgabe) {
      if (!aufgabe) return null;
      const match = aufgabe.match(/^([A-Z]+-\d+)/i);
      return match ? match[1] : null;
    }

    let scatterChart = null;
    let histogramChart = null;
    let pieChart = null;

    document.getElementById("csvfile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        let text = evt.target.result;
        text = text.replace(/,(\d)/g, '.$1'); // Convert decimal commas

        const delimiter = detectDelimiter(text);
        const csvRows = parseCSV(text, delimiter);

        if (!csvRows.length) {
          document.getElementById("groups").innerHTML = '';
          document.getElementById("headerDebug").innerHTML = '<div class="notfound">No data rows found.</div>';
          return;
        }

        const headerMap = normalizeHeaders(csvRows[0]);
        const aufgabeKey = Object.keys(headerMap).find(k => k.startsWith("aufgabe"));
        const stdKey = Object.keys(headerMap).find(k => k.startsWith("std"));
        const spKey = Object.keys(headerMap).find(k => k.startsWith("storypoints"));

        document.getElementById("headerDebug").innerHTML = '<div class="headers">Detected columns: ' +
          Object.keys(headerMap).map(h => `<code>${headerMap[h]}</code>`).join(', ') + '</div>';

        if (!aufgabeKey || !stdKey || !spKey) {
          document.getElementById("groups").innerHTML =
            `<div class="notfound">Could not find all required columns ("Aufgabe", "Std.", "StoryPoints")!<br>
            <br>Found columns: <code>${Object.keys(headerMap).map(h => headerMap[h]).join(", ")}</code></div>`;
          return;
        }

        // --- 1. Datenstruktur: ---
        const issuesArr = [];
        const groups = {};
        csvRows.forEach(row => {
          const key = extractIssueKey(row[headerMap[aufgabeKey]]);
          if (!key) return;
          let val = (row[headerMap[stdKey]] || "0").replace(",", ".");
          let eff = parseFloat(val || "0");
          let sp = parseFloat(row[headerMap[spKey]]);
          if (!isNaN(sp) && sp > 0) {
            let found = issuesArr.find(obj => obj.issue === key);
            if (!found) {
              found = {
                issue: key,
                totalEffort: 0,
                storyPoints: sp,
                effortPerSP: 0,
                rows: []
              };
              issuesArr.push(found);
            }
            found.totalEffort += isNaN(eff) ? 0 : eff;
            found.rows.push(row);
          }
        });
        // effortPerSP und Gruppen berechnen
        issuesArr.forEach(issue => {
          issue.effortPerSP = (issue.storyPoints && issue.storyPoints > 0) ?
              (issue.totalEffort / issue.storyPoints) : null;
          // Gruppieren
          const sp = issue.storyPoints;
          if (!groups[sp]) groups[sp] = [];
          groups[sp].push(issue);
        });

        // --- 2. Pie Chart: Verteilung der Story Points ---
        const storyPointCounts = {};
        issuesArr.forEach(issue => {
          const sp = issue.storyPoints;
          if (!storyPointCounts[sp]) storyPointCounts[sp] = 0;
          storyPointCounts[sp]++;
        });
        const pieLabels = Object.keys(storyPointCounts).sort((a, b) => Number(a) - Number(b));
        const pieData = pieLabels.map(l => storyPointCounts[l]);
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(document.getElementById("pieChart").getContext("2d"), {
          type: "pie",
          data: {
            labels: pieLabels.map(l => `${l} SP`),
            datasets: [{
              data: pieData,
              backgroundColor: [
                "#3c78d8", "#6fa8dc", "#b4a7d6", "#ffd966", "#93c47d", "#f6b26b", "#e06666", "#76a5af"
              ]
            }]
          },
          options: {
            plugins: {
              legend: { display: true, position: "bottom" },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.label}: ${ctx.parsed} Issues`
                }
              }
            }
          }
        });

        // --- 3. Scatterplot: Story Points (x) vs. Effort (y) ---
        const scatterData = issuesArr.map(issue => ({
          x: issue.storyPoints,
          y: issue.totalEffort,
          issue: issue.issue
        }));
        if (scatterChart) scatterChart.destroy();
        scatterChart = new Chart(document.getElementById("scatterChart").getContext("2d"), {
          type: "scatter",
          data: {
            datasets: [{
              label: "Issues",
              data: scatterData,
              pointRadius: 6,
              pointHoverRadius: 9,
              backgroundColor: "rgba(60,120,216,0.7)",
              borderColor: "#3463ad",
            }]
          },
          options: {
            plugins: {
              tooltip: {
                callbacks: {
                  label: (ctx) =>
                    `Issue: ${ctx.raw.issue}\nStory Points: ${ctx.raw.x}\nEffort: ${ctx.raw.y} h`
                }
              },
              legend: { display: false }
            },
            scales: {
              x: {
                type: "linear",
                title: { display: true, text: "Story Points" },
                beginAtZero: true
              },
              y: {
                title: { display: true, text: "Total Effort (h)" },
                beginAtZero: true
              }
            }
          }
        });

        // --- 4. Histogramm: Effort per Story Point ---
        const effortPerSPs = issuesArr
          .map(i => i.effortPerSP)
          .filter(v => v !== null && !isNaN(v));
        const bins = 8;
        const minV = Math.min(...effortPerSPs);
        const maxV = Math.max(...effortPerSPs);
        const step = (maxV - minV) / bins;
        const histBins = new Array(bins).fill(0);
        effortPerSPs.forEach(v => {
          let idx = Math.floor((v - minV) / step);
          if (idx >= bins) idx = bins - 1;
          histBins[idx]++;
        });
        const histLabels = [];
        for (let i = 0; i < bins; i++) {
          const from = (minV + i * step).toFixed(2);
          const to = (minV + (i + 1) * step).toFixed(2);
          histLabels.push(`${from}–${to}`);
        }
        if (histogramChart) histogramChart.destroy();
        histogramChart = new Chart(document.getElementById("histogramChart").getContext("2d"), {
          type: "bar",
          data: {
            labels: histLabels,
            datasets: [{
              label: "Issues",
              data: histBins,
              backgroundColor: "rgba(60,120,216,0.45)"
            }]
          },
          options: {
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { title: { display: true, text: "Effort per Story Point (h/SP)" }},
              y: { title: { display: true, text: "Number of Issues" }, beginAtZero: true }
            }
          }
        });

        // --- 5. Average Table: Durchschnitt pro Estimate ---
        let avgEffortHtml = `<div style="margin-top:12px;"><b>Average Total Effort per Estimate</b></div>
        <table class="average-table" style="margin-top:8px;">
          <thead>
            <tr>
              <th>Story Points</th>
              <th>Number of Issues</th>
              <th>Average Total Effort (h)</th>
            </tr>
          </thead>
          <tbody>`;
        pieLabels.forEach(sp => {
          const issues = groups[sp] || [];
          const avg = issues.length ? (issues.reduce((s, i) => s + i.totalEffort, 0) / issues.length).toFixed(2) : "–";
          avgEffortHtml += `
            <tr>
              <td>${sp}</td>
              <td>${issues.length}</td>
              <td>${avg}</td>
            </tr>
          `;
        });
        avgEffortHtml += `</tbody></table>`;
        document.getElementById("avgEffortDiv").innerHTML = avgEffortHtml;

        // --- 6. Gruppierung: Ausklappbar nach Story Points ---
        let groupsHtml = "";
        Object.keys(groups).sort((a,b)=>a-b).forEach(sp => {
          const list = groups[sp];
          groupsHtml += `<details>
            <summary>${sp} Story Point${sp==1?'':'s'} <span style="font-weight:normal;color:#567">(${list.length} Issues)</span></summary>
            <div class="group-list">
              <table>
                <thead>
                  <tr>
                    <th>Issue Key</th>
                    <th>Total Effort (h)</th>
                    <th>Effort per Story Point</th>
                  </tr>
                </thead>
                <tbody>
                  ${list.map(issue => `
                    <tr>
                      <td>${issue.issue}</td>
                      <td>${issue.totalEffort.toFixed(2)}</td>
                      <td>${issue.effortPerSP !== null ? issue.effortPerSP.toFixed(2) : "–"}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </details>`;
        });
        document.getElementById("groups").innerHTML = groupsHtml;
      };
      reader.readAsText(file, "utf-8");
    });
  </script>
</body>
</html>
